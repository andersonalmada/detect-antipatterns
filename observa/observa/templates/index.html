<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Observa - Anti-patterns Detection</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/static/style.css">
</head>

<body class="bg-light">
  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="login-overlay">
    <div class="card p-4 shadow-lg text-center login-box">
      <div class="login-logo-wrapper mb-3">
        <img src="/static/atlab.png" alt="Logo" class="login-logo">
      </div>

      <h3 class="mb-3">Observa - Login</h3>

      <input id="login-username" type="text" class="form-control mb-2" placeholder="Username">
      <input id="login-password" type="password" class="form-control mb-3" placeholder="Password">

      <button id="login-btn" class="btn btn-primary w-100">Login</button>
    </div>
  </div>

  <!-- APP CONTENT (fica escondido at√© o login) -->
  <div id="app-content" style="display:none;">

    <div class="container py-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="/">
          <img src="/static/atlab.png" alt="Logo" class="header-logo">
        </a>
        <h2 class="text-center" style="margin-left:-40px;">Observa - Framework</h2>
        <button id="logout-btn" class="btn btn-outline-secondary btn-sm">Logout</button>
      </div>

      <!-- NAV TABS -->
      <ul class="nav nav-tabs mb-4" id="mainTabs">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-setup">‚öôÔ∏è Setup</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-detection">üîç Detection</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-history">üìä History</button>
        </li>
        <button id="clear-db-btn" class="btn btn-outline-danger btn-sm ms-auto">
          üßπ Clear Database
        </button>
      </ul>

      <div class="tab-content">

        <!-- TAB 1 ‚Äî SETUP -->
        <div class="tab-pane fade show active" id="tab-setup">

          <!-- STEP 1 -->
          <button class="btn btn-link text-decoration-none" data-bs-toggle="collapse" data-bs-target="#source-help">
            How to configure a data source‚ùì
          </button>

          <div id="source-help" class="collapse text-muted small mt-2">
            <p>
              The user may select one of the existing data sources or register a new one.
              Each data source is composed of the following fields:
            </p>
            <ul>
              <li><strong>Name:</strong> Used to identify the data source that will be selected when running
                anti-pattern detection.</li>
              <li><strong>Data Input:</strong> Can be either a JSON file or an API endpoint. The user must choose one of
                these options.</li>
            </ul>
            <p class="mt-3"><strong>Expected data format:</strong></p>
            <p>
              The framework accepts JSON data structures. The exact schema may vary depending on the detector being
              used.
              If the source is retrieved from a remote API, the framework will issue a <strong>GET</strong> request and
              expects
              the response body to contain valid JSON.
              The following example demonstrates a commonly used structure where the input is a <strong>JSON
                array</strong>
              containing multiple records:
            </p>

            <pre class="bg-light border p-2 rounded" style="font-size: 0.85rem; max-height: 300px; overflow-y: auto;"><code>[
  {
    "alert_name": "HighCPUUsage",
    "count": 10
  },
  {
    "alert_name": "MemoryLeakWarning",
    "count": 5
  },
  {
    "alert_name": "DatabaseConnectionError",
    "count": 12
  },
  ...
]</code></pre>
            <p>üí° You can register multiple sources and select them using <strong>Ctrl</strong> (or <strong>Cmd</strong>
              on macOS).</p>
          </div>

          <div class="card mb-4 shadow-sm">
            <div class="card-body">
              <h4 class="card-title mb-3">1Ô∏è‚É£ Choose or Add a Data Source</h4>

              <div class="mb-3">
                <label class="form-label">Select Existing Source</label>
                <select id="source-select" class="form-select" multiple size="4"></select>
              </div>

              <hr class="my-4">

              <h5>Add New Source</h5>

              <div class="mb-3">
                <label class="form-label">Name:</label>
                <input type="text" id="new-source-name" class="form-control">
              </div>

              <div class="mb-3">
                <label class="form-label">Data Input:</label><br>
                <label class="form-label">Upload JSON File</label>
                <input type="file" id="new-source-file" class="form-control" accept=".json">
                <div class="text-center my-2">‚Äî or ‚Äî</div>
                <label class="form-label">Source API (for remote sources)</label>
                <input type="text" id="new-source-api" class="form-control">
              </div>

              <button id="add-source-btn" class="btn btn-success">‚ûï Add Source</button>
            </div>
          </div>

          <!-- STEP 2 -->
          <!-- STEP 1 -->
          <button class="btn btn-link text-decoration-none" data-bs-toggle="collapse" data-bs-target="#detector-help">
            How to configure a detector‚ùì
          </button>

          <div id="detector-help" class="collapse text-muted small mt-2">
            <p>
              The user may select one of the existing detectors or register a new one.
              Each detector is composed of the following fields:
            </p>
            <ul>
              <li><strong>Anti-pattern:</strong> The name of the anti-pattern that this detector is designed to
                identify.</li>
              <li><strong>Name:</strong> A label used to identify this detector when running anti-pattern detection.
              </li>
              <li><strong>Detector API:</strong> The endpoint of the service that performs the detection.</li>
            </ul>
            <p class="mt-3"><strong>Expected behavior of the Detector API:</strong></p>
            <p>
              The detector must expose an HTTP endpoint that accepts a <strong>POST request</strong> containing the data
              source payload in JSON format.
              After processing the content, the detector must return a JSON response with the following structure:
            </p>

            <ul>
              <li><strong>analyzed:</strong> Number of data items processed by the detector.</li>
              <li><strong>detected:</strong> Number of data entries classified as an anti-pattern.</li>
              <li><strong>data:</strong> The processed content or result set returned by the detector.</li>
            </ul>

            <p>Below is an example of a valid detector implementation in Python:</p>

            <pre class="bg-light border p-2 rounded" style="font-size: 0.85rem; overflow-x: auto;"><code>from flask import Flask, request, jsonify

app = Flask(__name__)

@app.post("/detector")
def detect():
    input_data = request.get_json()

    # Example processing (custom logic depends on the anti-pattern)
    for item in input_data:
      if int(item.get('count', 0)) > 10:
        item["exceeded"] = True
      else:
        item["exceeded"] = False
        
    count = sum(1 for x in input_data if x["exceeded"])       

    response = {
        "analyzed": len(input_data),
        "detected": count,
        "data": input_data
    }
    
    return jsonify(response)
      
if __name__ == "__main__":
    # Start detector API server
    app.run(host="0.0.0.0", port=5001)
</code></pre>
            <p>üí° You can register multiple detectors and select them using <strong>Ctrl</strong> (or
              <strong>Cmd</strong>
              on macOS).
            </p>
          </div>
          <div class="card mb-4 shadow-sm">
            <div class="card-body">
              <h4 class="card-title mb-3">2Ô∏è‚É£ Select or Add a Detector</h4>

              <div class="mb-3">
                <label class="form-label">Select Anti-pattern</label>
                <select id="antipattern-select" class="form-select"></select>
              </div>

              <div class="mb-3">
                <label class="form-label">Select Detector</label>
                <select id="detector-select" class="form-select" multiple size="4"></select>
              </div>

              <hr class="my-4">

              <h5>Add New Detector</h5>

              <div class="mb-3">
                <label class="form-label">Anti-pattern Name</label>
                <input type="text" id="antipattern-name" class="form-control">
              </div>

              <div class="mb-3">
                <label class="form-label">Detector Name</label>
                <input type="text" id="new-detector-name" class="form-control">
              </div>

              <div class="mb-3">
                <label class="form-label">Detector API (for remote detectors)</label>
                <input type="text" id="new-detector-api" class="form-control">
              </div>

              <button id="add-detector-btn" class="btn btn-success">‚ûï Add Detector</button>
            </div>
          </div>

        </div>

        <!-- TAB 2 ‚Äî DETEC√á√ÉO -->
        <div class="tab-pane fade" id="tab-detection">
          <div class="card shadow-sm">
            <div class="card-body">

              <h4 class="card-title mb-3">3Ô∏è‚É£ Run Detection</h4>
              <label class="form-label mb-1">To a request (N Data Sources x M Detectors):</label>
              <button id="run-btn" class="btn btn-primary w-100">üöÄ Run Detector</button>

              <div class="text-center my-2">‚Äî or ‚Äî</div>

              <label class="form-label mb-1">To perform multiple requests (1 Data Source √ó 1 Detector) using polling:</label>
                
              <div class="mt-3 d-flex align-items-center gap-2" style="max-width: 400px;">
                <div class="flex-grow-1">
                  <label class="form-label mb-1">Run interval (seconds)</label>
                  <input type="number" id="interval-seconds" class="form-control" value="10" min="1">
                </div>
                <div class="pt-3">
                  <button id="auto-run-btn" class="btn btn-outline-primary">‚è±Ô∏è Start Polling</button>
                </div>
              </div>

              <div class="mt-4">
                <h5>Result:</h5>
                <!--<pre id="result-output" class="bg-light border p-3 rounded" style="min-height: 120px;"></pre>-->
              </div>

              <div id="visual-output" class="mt-3"></div>
            </div>
          </div>
        </div>

        <!-- TAB 3 ‚Äî HIST√ìRICO -->
        <div class="tab-pane fade" id="tab-history">

          <div class="card shadow-sm mb-4">
            <div class="card-body">

              <h4 class="card-title mb-3">üìä Detection History</h4>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Choose a DataSource</label>
                  <select id="history-filter-source" class="form-select"></select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Choose a Detector</label>
                  <select id="history-filter-detector" class="form-select"></select>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Start date</label>
                  <input id="history-start-date" type="datetime-local" class="form-control">
                </div>

                <div class="col-md-6">
                  <label class="form-label">End date</label>
                  <input id="history-end-date" type="datetime-local" class="form-control">
                </div>
              </div>

              <button id="history-refresh-btn" class="btn btn-secondary w-100 mb-4">
                üîç Search
              </button>

              <canvas id="stackedBarHistory" height="150"></canvas>

              <div id="visual-output2" class="mt-3"></div>

            </div>
          </div>

        </div>

      </div>
    </div>
  </div> <!-- fecha app-content -->

  <script src="/static/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>